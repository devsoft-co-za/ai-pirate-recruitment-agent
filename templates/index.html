{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
    <h1>AI Pirate Booking Chatbot</h1>
    <p><i>Just for fun - from </i>DevSoft South Africa</p>
    <div class="form-group">
        <textarea id="chat-box" class="form-control" rows="10" readonly>Ahoy there matey welcome to Pirates Entertainment Agency, how can I help ye?</textarea>
    </div>
    <div class="form-group">
        <input type="text" id="prompt-input" class="form-control" placeholder="Enter your message">
    </div>
    <button id="send-button" class="btn btn-primary">Send</button>
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>

    <script>window.jQuery || document.write('<script src="/static/js/jquery-3.5.1.min.js"><\/script>')</script>
    <script>
        if (typeof jQuery === 'undefined') {
            document.write('<p style="color: red; font-weight: bold;">Error: jQuery failed to load. Please try refreshing the page.</p>');
        }
    </script>
    <script>
        $(document).ready(function() {
            $('#send-button').click(function() {
                sendMessage();
            });

            $('#prompt-input').keypress(function(event) {
                if (event.keyCode === 13) {
                    sendMessage();
                }
            });
            
            function sendMessage() {
                var prompt = $('#prompt-input').val();
                console.log("Sending prompt: " + prompt);
                var currentContent = $('#chat-box').val();
                $('#chat-box').val(currentContent + '\n\n' + prompt + '\n\n');
                $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                $('#prompt-input').val('');
                $('.spinner-border').show();

                $.post('/', {prompt: prompt}, function(data) {
                    console.log("Received response: " + data.response);
                    if (data.response) {
                        console.log("Appending response to chat box: " + data.response);
                        var currentContent = $('#chat-box').val();
                        $('#chat-box').val(currentContent + '\n\n' + data.response + '\n\n');
                        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    } else {
                        console.error("Received empty response from server.");
                    }
                    if (data.response === "I got to get to me bunk") {
                        $('#chat-box').val("Ahoy there matey welcome to Pirates Entertainment Agency, how can I help ye?");
                    }
                    $('.spinner-border').hide();
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Request failed: " + textStatus + ", " + errorThrown);
                    $('.spinner-border').hide();
                });
            }
        });
    </script>
{% endblock %}
