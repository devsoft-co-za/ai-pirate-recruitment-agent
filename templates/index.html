{% extends "base.html" %}

{% block title %}Recruitment Chat{% endblock %}

{% block content %}
    <h1>AI Pirate Recruitment Agent</h1>
    <p><i>Ask about the candidate's skills and experience!</i></p>
    <div class="form-group">
        <textarea id="chat-box" class="form-control" rows="10" readonly>Arrr! I be here to sing the praises of a mighty fine candidate. What ye want to know about their skills and experience?</textarea>
    </div>
    <div class="form-group">
        <input type="text" id="prompt-input" class="form-control" placeholder="Enter your message">
    </div>
    <button id="send-button" class="btn btn-primary">Send</button>
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>

    <script>window.jQuery || document.write('<script src="/static/js/jquery-3.5.1.min.js"><\/script>')</script>
    <script>
        if (typeof jQuery === 'undefined') {
            document.write('<p style="color: red; font-weight: bold;">Error: jQuery failed to load. Please try refreshing the page.</p>');
        }
    </script>
    <script>
        $(document).ready(function() {
            $('#send-button').click(function() {
                sendMessage();
            });

            $('#prompt-input').keypress(function(event) {
                if (event.keyCode === 13) {
                    sendMessage();
                }
            });
            
            function sendMessage() {
                var prompt = $('#prompt-input').val();
                console.log("Sending prompt: " + prompt);
                var currentContent = $('#chat-box').val();
                $('#chat-box').val(currentContent + '\n\n' + prompt + '\n\n');
                $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                $('#prompt-input').val('');
                $('.spinner-border').show();

                $.post('/', {prompt: prompt}, function(data) {
                    console.log("Received response: " + data.response);
                    if (data.response) {
                        console.log("Appending response to chat box: " + data.response);
                        var currentContent = $('#chat-box').val();
                        // Ensure we only add new content that isn't already present
                        if (!currentContent.includes(data.response)) {
                            $('#chat-box').val(currentContent + '\n\n' + data.response + '\n\n');
                        }
                        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                        $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
                    } else {
                        console.error("Received empty response from server.");
                    }
                    if (data.response === "I be needin' a grog break!") {
                        $('#chat-box').val("Arrr! Fresh from the galley - ask about the candidate's talents!");
                    }
                    $('.spinner-border').hide();
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Request failed: " + textStatus + ", " + errorThrown);
                    var errorMsg = "Parrot navigation failure! ";
                    if (jqXHR.status === 502) {
                        errorMsg += "Captain's log: Bad Gateway (check server ports)";
                    } else if (jqXHR.status === 504) {
                        errorMsg += "Parrot flew too far! Try again!";
                    }
                    var currentContent = $('#chat-box').val();
                    $('#chat-box').val(currentContent + '\n\n' + errorMsg + '\n\n');
                    $('.spinner-border').hide();
                });
            }
        });
    </script>
{% endblock %}
